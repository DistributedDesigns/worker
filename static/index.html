<!DOCTYPE html>
<html lang="en">
<head>
  <title>Stock Market</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
<script type="text/javascript">
// window.onload = function () {
//     // This should occur on response 200 from login
//     var conn;
//     var msg = document.getElementById("msg");
//     var log = document.getElementById("log");
//     function appendLog(item) {
//         var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
//         log.appendChild(item);
//         if (doScroll) {
//             log.scrollTop = log.scrollHeight - log.clientHeight;
//         }
//     }
//     document.getElementById("form").onsubmit = function () {
//         if (!conn) {
//             return false;
//         }
//         if (!msg.value) {
//             return false;
//         }
//         conn.send(msg.value);
//         msg.value = "";
//         return false;
//     };
//     if (window["WebSocket"]) {
//         conn = new WebSocket("ws://" + document.location.host + "/ws");
//         conn.onopen = function (evt) {
//           conn.send("Bob")
//         }
//         conn.onclose = function (evt) {
//             var item = document.createElement("div");
//             item.innerHTML = "<b>Connection closed.</b>";
//             appendLog(item);
//         };
//         conn.onmessage = function (evt) {
//             var messages = evt.data.split('\n');
//             for (var i = 0; i < messages.length; i++) {
//                 var item = document.createElement("div");
//                 item.innerText = messages[i];
//                 appendLog(item);
//             }
//         };
//     } else {
//         var item = document.createElement("div");
//         item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
//         appendLog(item);
//     }
// };
function SendPost(theCommand) {
  var url = '/push';
  var request = new XMLHttpRequest();
  request.open("POST", url, true);

  var jsonPayload = JSON.stringify({command: theCommand})
  request.send(jsonPayload);
}

function appendLog(item) {
    var log = document.getElementById("log");
    var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
    log.appendChild(item);
    if (doScroll) {
        log.scrollTop = log.scrollHeight - log.clientHeight;
    }
  // xhr.onload = function() {
  //   if (request.status >= 200 && request.status < 400) {
  //     // Success!
  //     // var data = request.responseText;
  //     // console.log(data)
  //     doAuth(request.responseText)
  //   } else {
  //     // We reached our target server, but it returned an error
  //     console.log("Failed to Auth user")
  //   }
  // };

  // request.onerror = function() {
  //   // There was a connection error of some sort
  // };
  var jsonPayload = JSON.stringify({command: theCommand})
  request.send(jsonPayload);

}

function doAuth(rawData) {
  localStorage["user"] = localStorage["user"] || document.getElementById("userid").value
  document.getElementById('loginview').style.display = 'none';
  document.getElementById('authview').style.display = 'block';
  var conn;
  var msg = document.getElementById("msg");
  document.getElementById("form").onsubmit = function () {
      if (!conn) {
          return false;
      }
      if (!msg.value) {
          return false;
      }
      conn.send(msg.value);
      msg.value = "";
      return false;
  };
  if (window["WebSocket"]) {
      conn = new WebSocket("ws://" + document.location.host + "/ws");
      conn.onopen = function (evt) {
        console.log("CON OPEN")
        conn.send(localStorage["user"])
      }
      conn.onclose = function (evt) {
          conn.send("MY ASS")
          var item = document.createElement("div");
          item.innerHTML = "<b>Connection closed.</b>";
          appendLog(item);
      };
      conn.onmessage = function (evt) {
          var messages = evt.data.split('\n');
          for (var i = 0; i < messages.length; i++) {
              var item = document.createElement("div");
              item.innerText = messages[i];
              appendLog(item);
          }
      };
  } else {
      var item = document.createElement("div");
      item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
      appendLog(item);
  }
  console.log("Auth Successful")
}
function Auth() {
  var request = new XMLHttpRequest();
  request.open('POST', '/auth', true);

  request.onload = function() {
    if (request.status >= 200 && request.status < 400) {
      // Success!
      // var data = request.responseText;
      // console.log(data)
      doAuth(request.responseText)
    } else {
      // We reached our target server, but it returned an error
      console.log("Failed to Auth user")
    }
  };

  request.onerror = function() {
    // There was a connection error of some sort
  };

  request.send(JSON.stringify({user: document.getElementById("userid").value, pass: document.getElementById("pwd").value}));
}
function Create() {
  var request = new XMLHttpRequest();
  request.open('POST', '/create', true);

  request.onload = function() {
    if (request.status >= 200 && request.status < 400) {
      // Success!
      // var data = request.responseText;
      // console.log(data)
      doAuth(request.responseText)
      console.log("Create Successful")
    } else {
      // We reached our target server, but it returned an error
      console.log("Failed to create user")
    }
  };

  request.onerror = function() {
    // There was a connection error of some sort
  };

  request.send(JSON.stringify({user: document.getElementById("userid").value, pass: document.getElementById("pwd").value}));
}
function Add() {
  SendPost("ADD,"+localStorage["user"]+","+document.getElementById("addamount").value)
  console.log("Add")
}
function Quote() {
  SendPost("QUOTE,"+localStorage["user"]+","+document.getElementById("quotestocksymbol").value.toUpperCase())
  console.log("Quote")
}
function Buy() {
  SendPost("BUY,"+localStorage["user"]+","+document.getElementById("buystocksymbol").value.toUpperCase()+","+document.getElementById("buyamount").value)
  console.log("Buy")
}
function CommitBuy() {
  SendPost("COMMIT_BUY,"+localStorage["user"])
  console.log("Commit Buy")
}
function CancelBuy() {
  SendPost("CANCEL_BUY,"+localStorage["user"])
  console.log("Cancel Buy")
}
function Sell() {
  SendPost("SELL,"+localStorage["user"]+","+document.getElementById("sellstocksymbol").value.toUpperCase()+","+document.getElementById("sellamount").value)
  console.log("Sell")
}
function CommitSell() {
  SendPost("COMMIT_SELL,"+localStorage["user"])
  console.log("Commit Sell")
}
function CancelSell() {
  SendPost("CANCEL_SELL,"+localStorage["user"])
  console.log("Cancel Sell")
}
function SetBuyAmount() {
  SendPost("SET_BUY_AMOUNT,"+localStorage["user"]+","+document.getElementById("setbuystocksymbol").value.toUpperCase()+","+document.getElementById("setbuyamount").value)
  console.log("Set buy amount")
}
function CancelSetBuy() {
  SendPost("CANCEL_SET_BUY,"+localStorage["user"]+","+document.getElementById("cancelbuystocksymbol").value.toUpperCase())
  console.log("Cancel set buy")
}
function SetBuyTrigger() {
  SendPost("SET_BUY_TRIGGER,"+localStorage["user"]+","+document.getElementById("setbuytrigstocksymbol").value.toUpperCase()+","+document.getElementById("setbuytrigamount").value)
  console.log("Set buy trigger")
}
function SetSellAmount() {
  SendPost("SET_SELL_AMOUNT,"+localStorage["user"]+","+document.getElementById("setsellstocksymbol").value.toUpperCase()+","+document.getElementById("setsellamount").value)
  console.log("Set Sell Amount")
}
function CancelSetSell() {
  SendPost("CANCEL_SET_SELL,"+localStorage["user"]+","+document.getElementById("cancelsellstocksymbol").value.toUpperCase())
  console.log("Cancel set sell")
}
function SetSellTrigger() {
  SendPost("SET_SELL_TRIGGER,"+localStorage["user"]+","+document.getElementById("setselltrigstocksymbol").value.toUpperCase()+","+document.getElementById("setselltrigamount").value)
  console.log("Set sell trigger")
}
function Dumplog() {
  var userID = localStorage["user"]
  if(userID === "admin"){
    SendPost("DUMPLOG,out.dump")
    console.log("Admin Dump")
  }
  else
  {
    SendPost("DUMPLOG"+localStorage["user"]+","+document.getElementById("dumplogfile").value)
    console.log("User Dump")
  }
}
function DisplaySummary() {
  SendPost("DISPLAY_SUMMARY,"+localStorage["user"])
  console.log("Display summary")
}
</script>
<div id="container" style="float: left; width: 30%; margin: 5px 20px;">
  <form id="loginview" style="display: none;">
    <h2>Credentials:</h2>
    <div class="form-group">
      <label for="userid">User ID:</label>
      <input type="text" class="form-control" id="userid" placeholder="Enter user ID">
    </div>
    <div class="form-group">
      <label for="pwd">Password:</label>
      <input type="password" class="form-control" id="pwd" placeholder="Enter password">
    </div>
    <button type="button" class="btn btn-default" onclick="Create()">Create</button>
    <button type="button" class="btn btn-default" onclick="Auth()">Log In</button>
  </form>
  <div id="authview" style="display: none;">
    <div class="container" style="display: none;">
        <div id="form">
          <input type="submit" value="Send" />
          <input type="text" id="msg" size="64"/>
        </div>
    </div>
    <h2>Add:</h2>
    <form>
      <div class="form-group">
        <label for="addamount">Amount:</label>
        <input type="text" class="form-control" id="addamount" placeholder="Enter amount">
      </div>
      <button type="button" class="btn btn-default" onclick="Add()">Submit</button>
    </form>

    <h2>Quote:</h2>
    <form>
      <div class="form-group">
        <label for="quotestocksymbol">Stock Symbol:</label>
        <input type="text" class="form-control" id="quotestocksymbol" placeholder="Enter stock symbol">
      </div>
      <button type="button" class="btn btn-default" onclick="Quote()">Submit</button>
    </form>

    <h2>Buy:</h2>
    <form>
      <div class="form-group">
        <label for="buystocksymbol">Stock Symbol:</label>
        <input type="text" class="form-control" id="buystocksymbol" placeholder="Enter stock symbol">
      </div>
      <div class="form-group">
        <label for="buyamount">Amount:</label>
        <input type="text" class="form-control" id="buyamount" placeholder="Enter amount">
      </div>
      <button type="button" class="btn btn-default" onclick="Buy()">Submit</button>
    </form>

    <h2>Commit Buy:</h2>
    <form>
      <button type="button" class="btn btn-default" onclick="CommitBuy()">Submit</button>
    </form>

    <h2>Cancel Buy:</h2>
    <form>
      <button type="button" class="btn btn-default" onclick="CancelBuy()">Submit</button>
    </form>

    <h2>Sell:</h2>
    <form>
      <div class="form-group">
        <label for="sellstocksymbol">Stock Symbol:</label>
        <input type="text" class="form-control" id="sellstocksymbol" placeholder="Enter stock symbol">
      </div>
      <div class="form-group">
        <label for="sellamount">Amount:</label>
        <input type="text" class="form-control" id="sellamount" placeholder="Enter amount">
      </div>
      <button type="button" class="btn btn-default" onclick="Sell()">Submit</button>
    </form>

    <h2>Commit Sell:</h2>
    <form>
      <button type="button" class="btn btn-default" onclick="CommitSell()">Submit</button>
    </form>

    <h2>Cancel Sell:</h2>
    <form>
      <button type="button" class="btn btn-default" onclick="CancelSell()">Submit</button>
    </form>

    <h2>Set Buy Amount:</h2>
    <form>
      <div class="form-group">
        <label for="setbuystocksymbol">Stock Symbol:</label>
        <input type="text" class="form-control" id="setbuystocksymbol" placeholder="Enter stock symbol">
      </div>
      <div class="form-group">
        <label for="setbuyamount">Amount:</label>
        <input type="text" class="form-control" id="setbuyamount" placeholder="Enter amount">
      </div>
      <button type="button" class="btn btn-default" onclick="SetBuyAmount()">Submit</button>
    </form>

    <h2>Cancel Set Buy:</h2>
    <form>
      <div class="form-group">
        <label for="cancelbuystocksymbol">Stock Symbol:</label>
        <input type="text" class="form-control" id="cancelbuystocksymbol" placeholder="Enter stock symbol">
      </div>
      <button type="button" class="btn btn-default" onclick="CancelSetBuy()">Submit</button>
    </form>

    <h2>Set Buy Trigger:</h2>
    <form>
      <div class="form-group">
        <label for="setbuytrigstocksymbol">Stock Symbol:</label>
        <input type="text" class="form-control" id="setbuytrigstocksymbol" placeholder="Enter stock symbol">
      </div>
      <div class="form-group">
        <label for="setbuytrigamount">Amount:</label>
        <input type="text" class="form-control" id="setbuytrigamount" placeholder="Enter amount">
      </div>
      <button type="button" class="btn btn-default" onclick="SetBuyTrigger()">Submit</button>
    </form>

    <h2>Set Sell Amount:</h2>
    <form>
      <div class="form-group">
        <label for="setsellstocksymbol">Stock Symbol:</label>
        <input type="text" class="form-control" id="setsellstocksymbol" placeholder="Enter stock symbol">
      </div>
      <div class="form-group">
        <label for="setsellamount">Amount:</label>
        <input type="text" class="form-control" id="setsellamount" placeholder="Enter amount">
      </div>
      <button type="button" class="btn btn-default" onclick="SetSellAmount()">Submit</button>
    </form>

    <h2>Cancel Set Sell:</h2>
    <form>
      <div class="form-group">
        <label for="cancelsellstocksymbol">Stock Symbol:</label>
        <input type="text" class="form-control" id="cancelsellstocksymbol" placeholder="Enter stock symbol">
      </div>
      <button type="button" class="btn btn-default" onclick="CancelSetSell()">Submit</button>
    </form>

    <h2>Set Sell Trigger:</h2>
    <form>
      <div class="form-group">
        <label for="setselltrigstocksymbol">Stock Symbol:</label>
        <input type="text" class="form-control" id="setselltrigstocksymbol" placeholder="Enter stock symbol">
      </div>
      <div class="form-group">
        <label for="setselltrigamount">Amount:</label>
        <input type="text" class="form-control" id="setselltrigamount" placeholder="Enter amount">
      </div>
      <button type="button" class="btn btn-default" onclick="SetSellTrigger()">Submit</button>
    </form>

    <h2>Dumplog:</h2>
    <form>
      <div class="form-group">
        <label for="dumplogfile">Amount:</label>
        <input type="text" class="form-control" id="dumplogfile" placeholder="Enter file name">
      </div>
      <button type="button" class="btn btn-default" onclick="Dumplog()">Submit</button>
    </form>

    <h2>Display Summary:</h2>
    <form>
      <button type="button" class="btn btn-default" onclick="DisplaySummary()">Submit</button>
    </form>
  </div>
</div>
<div style="float: left; width: 5%;"></div>
<div id="log" style="float: right; width: 65%; margin: 10px;">
  <h2> Output: </h2>
</div>
<script type="text/javascript">
if (localStorage["user"]) {
  document.getElementById('loginview').style.display = 'none';
  document.getElementById('authview').style.display = 'block';
  doAuth()
} else {
  document.getElementById('loginview').style.display = 'block';
  document.getElementById('authview').style.display = 'none';
}
</script>
</body>
</html>
